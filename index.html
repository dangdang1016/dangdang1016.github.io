<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>響應式 3D 模型與無限編輯器</title>
    <style>
        /* ------------------ 基礎與全局樣式 ------------------ */
        body {
            margin: 0;
            display: flex;
            background-color: #1a1a1a;
            color: white;
            font-family: Arial, sans-serif;
            /* 確保主體不會水平滾動 */
            overflow-x: hidden; 
            overflow-y: hidden;
            min-height: 100vh;
        }

        /* ------------------ 佈局容器 ------------------ */
        #app-container {
            display: flex;
            width: 100%;
            height: 100vh;
        }
        
        /* ------------------ 1. 側邊 Blocky 功能面板 ------------------ */
        #blocky-panel {
            position: fixed;
            top: 0;
            left: 0;
            height: 100vh;
            background-color: #2c3e50;
            padding: 10px;
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.5);
            transition: transform 0.3s ease-out, width 0.3s ease-out, padding 0.3s ease-out;
            z-index: 1000; 
            overflow-y: auto;
        }
        #close-btn {
            position: sticky; 
            top: 0;
            float: right;
            background: #34495e;
            color: white;
            border: none;
            padding: 8px 12px;
            cursor: pointer;
            border-radius: 4px;
            font-size: 16px;
            margin-bottom: 10px;
        }
        /* Blocky 積木樣式模擬 */
        .blocky-group h4 { color: #bdc3c7; margin-top: 15px; border-bottom: 1px solid #34495e; padding-bottom: 5px; }
        .blocky-item { list-style: none; padding: 8px 12px; margin: 8px 0; border-radius: 5px; cursor: grab; font-weight: bold; font-size: 14px; box-shadow: 1px 1px 3px rgba(0, 0, 0, 0.3); }
        .blocky-control { background-color: #e74c3c; } 
        .blocky-data { background-color: #3498db; }  
        .blocky-logic { background-color: #2ecc71; } 

        /* ------------------ 2. 主內容區域 (3D 模型 / 編輯器) ------------------ */
        #main-content {
            flex-grow: 1; 
            display: flex; 
            justify-content: center;
            align-items: center;
            height: 100vh;
            position: relative; 
            transition: margin-left 0.3s ease-out;
            margin-left: 0; 
        }

        /* 核心視圖定位：確保兩者絕對定位並佔滿父容器 */
        #model-view, #editor-view {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        
        /* ------------------ 3D 模型視圖樣式 ------------------ */
        .view-3d #model-view { 
            display: flex; 
            justify-content: center; 
            align-items: center; 
        }
        .view-3d #editor-view { display: none; } 
        /* touch-action: none 確保觸摸事件不會被瀏覽器預設行為（如滾動）干擾 */
        #phone-container { width: 300px; height: 600px; perspective: 1500px; transform-origin: center center; cursor: grab; touch-action: none; }
        #iphone-body { width: 100%; height: 100%; position: relative; transform-style: preserve-3d; transition: transform 0.1s ease-out; }
        .face { position: absolute; width: 300px; height: 600px; border-radius: 40px; border: 5px solid #222; background: #444; opacity: 0.95; --thickness: 10px; }
        .front { background: radial-gradient(circle at 70% 30%, #444, #111); transform: translateZ(var(--thickness)); }
        .back { background: linear-gradient(135deg, #a7a9ac, #6c6f71); transform: rotateY(180deg) translateZ(var(--thickness)); }

        /* ------------------ 3. 無限編輯器視圖樣式 ------------------ */
        .view-editor #model-view { display: none; } 
        .view-editor #editor-view { 
            display: block; 
            /* 關鍵：編輯器視圖必須隱藏內部無限畫布的溢出 */
            overflow: hidden; 
            position: relative; 
        }
        
        #infinite-canvas-container {
            position: absolute;
            /* 這是導致溢出的元素，但它的溢出會被 #editor-view 隱藏 */
            width: 3000px; 
            height: 3000px;
            background: linear-gradient(-90deg, #2a2a2a 1px, transparent 1px),
                        linear-gradient(#2a2a2a 1px, transparent 1px);
            background-size: 50px 50px; 
            cursor: grab;
            user-select: none;
        }

        /* 編輯器頂部控制按鈕 (僅在編輯器視圖中生效) */
        .view-editor #editor-controls {
            position: absolute;
            top: 20px; 
            left: 75px; 
            z-index: 10;
        }
        
        #editor-controls button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
            margin-right: 10px;
            font-size: 14px;
        }
        .view-3d #editor-controls {
            display: none;
        }


        /* ------------------ 4. 右下角編輯器切換按鈕 (手機版/電腦版共用) ------------------ */
        #editor-switch-btn {
            /* 修正: 使用固定定位 (fixed) 確保按鈕永遠相對於視窗 (viewport) 定位，
               不會被 3000px 的內容推擠出畫面 */
            position: fixed; 
            bottom: 20px;
            right: 20px;
            background-color: #2ecc71;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            display: block; 
            z-index: 500;
        }
        
        /* ------------------ 5. 手機長按/右鍵選單 ------------------ */
        #context-menu {
            position: fixed;
            background-color: #333;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
            list-style: none;
            padding: 0;
            margin: 0;
            z-index: 2000;
            max-height: 200px; 
            overflow-y: auto;
            display: none; 
        }
        #context-menu li {
            padding: 10px 20px;
            cursor: pointer;
            white-space: nowrap;
            border-bottom: 1px solid #444;
            transition: background-color 0.2s;
        }
        #context-menu li:hover {
            background-color: #555;
        }
        #context-menu li:last-child {
            border-bottom: none;
        }

        /* ------------------ 6. 響應式佈局 (Media Queries) ------------------ */
        
        /* 漢堡按鈕基礎樣式 (三條線) */
        .hamburger-btn {
            position: fixed;
            top: 20px;
            left: 20px;
            width: 30px;
            height: 24px; 
            background: rgba(0, 0, 0, 0.7);
            border: none;
            border-radius: 4px;
            z-index: 1001;
            padding: 6px 5px; 
            display: flex;
            flex-direction: column;
            justify-content: space-between; 
            cursor: pointer;
        }
        .hamburger-btn span {
            display: block;
            height: 3px; 
            width: 100%;
            background: white;
            border-radius: 1px;
        }

        /* 手機版 (Mobile < 769px) */
        @media (max-width: 768px) {
            #blocky-panel {
                width: 33.33vw; 
                min-width: 100px;
                transform: translateX(-100%); 
            }
            #blocky-panel.open {
                transform: translateX(0);
            }
            #editor-switch-btn { 
                display: block !important; 
            }
            .desktop-restore { display: none !important; }
        }

        /* 電腦版 (Desktop >= 769px) */
        @media (min-width: 769px) {
            .hamburger-btn:not(.desktop-restore) {
                display: none; 
            }
            #blocky-panel {
                width: 33.33vw; 
                max-width: 300px; 
                position: relative; 
                transform: translateX(0); 
                padding: 10px;
            }
            #blocky-panel.hidden {
                width: 0;
                padding: 0;
                box-shadow: none;
                pointer-events: none; 
            }
            
            #editor-switch-btn { 
                display: block;
            }

            .desktop-restore {
                display: none; 
                position: fixed;
                left: 20px;
                top: 20px;
                z-index: 1001;
            }
            #blocky-panel.hidden ~ #main-content .desktop-restore {
                display: flex; 
                pointer-events: auto; 
            }
        }
    </style>
</head>
<body>

    <div id="app-container">
        <!-- 1. Blocky 功能面板 (預設隱藏) -->
        <aside id="blocky-panel">
            <button id="close-btn" onclick="toggleSidebar()">縮進</button>
            <h2>Blocky 功能列表</h2>
            <div class="blocky-group">
                <h4>控制 (Control)</h4>
                <ul>
                    <li class="blocky-item blocky-control">if 條件判斷</li>
                    <li class="blocky-item blocky-control">else 否則執行</li>
                    <li class="blocky-item blocky-control">while 迴圈</li>
                    <li class="blocky-item blocky-control">for 迴圈</li>
                </ul>
            </div>
            <div class="blocky-group">
                <h4>數據與結構 (Data & Struct)</h4>
                <ul>
                    <li class="blocky-item blocky-data">Struct 定義</li>
                    <li class="blocky-item blocky-data">變量初始化</li>
                    <li class="blocky-item blocky-data">陣列 Array</li>
                    <li class="blocky-item blocky-data">列表 List</li>
                </ul>
            </div>
            <div class="blocky-group">
                <h4>邏輯與運算 (Logic & Math)</h4>
                <ul>
                    <li class="blocky-item blocky-logic">AND 且 / OR 或</li>
                    <li class="blocky-item blocky-logic">Not 非</li>
                </ul>
            </div>
        </aside>

        <!-- 2. 主內容區域 (3D 模型 / 編輯器) -->
        <section id="main-content" class="view-3d">
            
            <!-- 手機版的三條線按鈕 -->
            <button class="hamburger-btn" onclick="toggleSidebar()">
                <span></span><span></span><span></span>
            </button>
            <!-- 電腦版隱藏 Blocky 後重新顯示的按鈕 -->
            <button class="hamburger-btn desktop-restore" onclick="toggleSidebar()">
                <span></span><span></span><span></span>
            </button>
            
            <!-- A. 3D 模型視圖 -->
            <div id="model-view">
                <div id="phone-container">
                    <div id="iphone-body">
                        <div class="face front"><div id="dynamic-island"></div></div>
                        <div class="face back"></div>
                    </div>
                </div>
            </div>

            <!-- B. 無限編輯器視圖 -->
            <div id="editor-view">
                
                <div id="editor-controls">
                    <button id="visual-design-btn" onclick="switchView('3d')">視覺化設計 (3D 模型)</button>
                </div>
                
                <!-- 無限平面 -->
                <div id="infinite-canvas-container">
                    <h1 style="color:rgba(255,255,255,0.2); position:absolute; top: 1500px; left: 1500px; transform:translate(-50%, -50%);">
                        無限編輯平面 (拖曳移動)
                    </h1>
                </div>

                <!-- 手機長按/電腦右鍵選單 -->
                <ul id="context-menu" onclick="hideContextMenu()">
                    <li>beginplay 啟動</li>
                    <li>print 輸出</li>
                    <li>if 條件判斷</li>
                    <li>else 否則執行</li>
                    <li>while 迴圈</li>
                    <li>Struct 結構體</li>
                    <li>Function 函數</li>
                    <li>Variable 變數</li>
                    <li>Array 陣列</li>
                </ul>
            </div>
            
            <!-- 右下角編輯器切換按鈕 (手機/電腦共用) -->
            <button id="editor-switch-btn" onclick="switchView('editor')">
                進入編輯器
            </button>
        </section>
    </div>
    
    <script>
        const phoneBody = document.getElementById('iphone-body');
        const blockyPanel = document.getElementById('blocky-panel');
        const mainContent = document.getElementById('main-content');
        const closeBtn = document.getElementById('close-btn');
        const canvasContainer = document.getElementById('infinite-canvas-container');
        const contextMenu = document.getElementById('context-menu');
        const editorView = document.getElementById('editor-view');
        
        // 3D 模型互動變量
        let currentScale = 1;
        let rotationX = 15;
        let rotationY = -45;
        let is3DDragging = false;
        let is3DTouching = false;
        let lastMouseX = 0;
        let lastMouseY = 0;
        let initialPinchDistance = null;
        const rotationSensitivity = 0.5;
        const scaleStep = 0.1;

        // 編輯器互動變量
        let isEditorDragging = false;
        let startX = 0;
        let startY = 0;
        let currentTranslateX = -1000;
        let currentTranslateY = -1000;
        let longPressTimer = null;
        const LONG_PRESS_DURATION = 500; 

        // ------------------ 視圖切換與響應式邏輯 ------------------

        function isMobile() {
            return window.innerWidth <= 768;
        }

        function switchView(viewName) {
            mainContent.className = `view-${viewName}`;
            hideContextMenu();
        }

        function toggleSidebar() {
            if (isMobile()) {
                blockyPanel.classList.toggle('open');
            } else {
                const isHidden = !blockyPanel.classList.contains('hidden');
                
                if (isHidden) {
                    blockyPanel.classList.add('hidden');
                    closeBtn.style.display = 'none'; 
                } else {
                    blockyPanel.classList.remove('hidden');
                    closeBtn.style.display = 'block'; 
                }
                closeBtn.textContent = isHidden ? '展開' : '縮進';
            }
        }
        
        window.addEventListener('load', () => {
            if (!isMobile()) {
                blockyPanel.classList.add('hidden'); 
                closeBtn.style.display = 'none'; 
                closeBtn.textContent = '展開';
            } else {
                blockyPanel.classList.remove('open'); 
                closeBtn.textContent = '縮進';
            }
            // 初始設定 Canvas 的平移
            canvasContainer.style.transform = `translate(${currentTranslateX}px, ${currentTranslateY}px)`;
            updateTransform();
        });

        // ------------------ 3D 模型互動邏輯 (包含手勢) ------------------

        function updateTransform() {
            phoneBody.style.transform = `
                scale(${currentScale}) 
                rotateX(${rotationX}deg) 
                rotateY(${rotationY}deg)
            `;
        }
        
        function getDistance(touch1, touch2) {
            const dx = touch1.clientX - touch2.clientX;
            const dy = touch1.clientY - touch2.clientY;
            return Math.sqrt(dx * dx + dy * dy);
        }

        const phoneContainer = document.getElementById('phone-container');
        
        // 桌面 - 滑鼠滾輪縮放
        phoneContainer.addEventListener('wheel', (e) => {
            if (mainContent.classList.contains('view-3d')) { 
                e.preventDefault(); 
                currentScale += (e.deltaY < 0 ? scaleStep : -scaleStep); 
                currentScale = Math.min(Math.max(0.3, currentScale), 3.0); 
                updateTransform(); 
            }
        });
        
        // 桌面 - 滑鼠拖曳旋轉
        phoneContainer.addEventListener('mousedown', (e) => {
            if (mainContent.classList.contains('view-3d') && e.button === 0) { 
                is3DDragging = true; 
                lastMouseX = e.clientX; 
                lastMouseY = e.clientY; 
                phoneContainer.classList.add('dragging'); 
            }
        });
        document.addEventListener('mousemove', (e) => {
            if (!is3DDragging) return; 
            rotationY += (e.clientX - lastMouseX) * rotationSensitivity; 
            rotationX -= (e.clientY - lastMouseY) * rotationSensitivity; 
            lastMouseX = e.clientX; 
            lastMouseY = e.clientY; 
            updateTransform();
        });
        document.addEventListener('mouseup', () => {
            if (is3DDragging) { 
                is3DDragging = false; 
                phoneContainer.classList.remove('dragging'); 
            }
        });

        // 手機 - 觸摸開始 (旋轉或縮放)
        phoneContainer.addEventListener('touchstart', (e) => {
            if (!mainContent.classList.contains('view-3d')) return;
            
            if (e.touches.length === 1) {
                is3DTouching = true;
                lastMouseX = e.touches[0].clientX;
                lastMouseY = e.touches[0].clientY;
                initialPinchDistance = null; 
            } else if (e.touches.length === 2) {
                e.preventDefault(); 
                is3DTouching = false;
                initialPinchDistance = getDistance(e.touches[0], e.touches[1]);
            }
        }, { passive: false });

        // 手機 - 觸摸移動 (執行旋轉或縮放)
        phoneContainer.addEventListener('touchmove', (e) => {
            if (!mainContent.classList.contains('view-3d')) return;

            if (e.touches.length === 1 && is3DTouching) {
                e.preventDefault(); 
                rotationY += (e.touches[0].clientX - lastMouseX) * rotationSensitivity * 2; 
                rotationX -= (e.touches[0].clientY - lastMouseY) * rotationSensitivity * 2;
                lastMouseX = e.touches[0].clientX;
                lastMouseY = e.touches[0].clientY;
                updateTransform();
            } else if (e.touches.length === 2 && initialPinchDistance !== null) {
                e.preventDefault(); 
                const currentDistance = getDistance(e.touches[0], e.touches[1]);
                const scaleFactor = currentDistance / initialPinchDistance;
                
                let newScale = currentScale * scaleFactor;
                newScale = Math.min(Math.max(0.3, newScale), 3.0);
                
                currentScale = newScale;
                initialPinchDistance = currentDistance; 
                
                updateTransform();
            }
        }, { passive: false });

        // 手機 - 觸摸結束 (停止操作)
        phoneContainer.addEventListener('touchend', () => {
            is3DTouching = false;
            initialPinchDistance = null;
        });


        // ------------------ 無限編輯器互動邏輯 ------------------
        
        // 顯示選單
        function showContextMenu(x, y) {
            contextMenu.style.left = `${x}px`;
            contextMenu.style.top = `${y}px`;
            contextMenu.style.display = 'block';
        }

        // 隱藏選單
        function hideContextMenu() {
            contextMenu.style.display = 'none';
        }

        // 處理長按 (手機版)
        function handleLongPress(e, x, y) {
             if (isMobile()) {
                const clientX = e.touches ? e.touches[0].clientX : x;
                const clientY = e.touches ? e.touches[0].clientY : y;
                showContextMenu(clientX, clientY);
            }
        }
        
        // ----------------- 右鍵選單事件處理 (電腦版) -----------------
        editorView.addEventListener('contextmenu', (e) => {
            if (!isMobile() && mainContent.classList.contains('view-editor')) {
                e.preventDefault(); 
                if (!e.target.closest('#editor-controls button')) {
                    showContextMenu(e.clientX, e.clientY);
                }
            }
        });

        // 點擊空白處關閉選單 (針對電腦和手機)
        document.addEventListener('click', (e) => {
            if (!contextMenu.contains(e.target) && mainContent.classList.contains('view-editor')) {
                hideContextMenu();
            }
        });

        // 統一處理滑鼠/觸摸開始
        function handleEditorStart(e) {
            if (!mainContent.classList.contains('view-editor')) return;
            
            hideContextMenu();

            const isTouch = e.touches;
            const clientX = isTouch ? e.touches[0].clientX : e.clientX;
            const clientY = isTouch ? e.touches[0].clientY : e.clientY;
            
            // 如果點擊目標是 controls 裡的按鈕、選單或漢堡按鈕，則不拖曳
            if (e.target.closest('#editor-controls button') || e.target.closest('#context-menu li') || e.target.closest('.hamburger-btn') || e.target.closest('#editor-switch-btn')) {
                return; 
            }
            
            // 啟動拖曳 (非右鍵且單指觸摸)
            if (e.button !== 2 && (!isTouch || e.touches.length === 1)) { 
                isEditorDragging = true;
                startX = clientX;
                startY = clientY;
                
                const style = window.getComputedStyle(canvasContainer);
                const transform = style.transform === 'none' ? 'matrix(1, 0, 0, 1, 0, 0)' : style.transform;
                const matrix = transform.match(/matrix.*\((.+)\)/);
                if (matrix) {
                     const values = matrix[1].split(', ');
                     currentTranslateX = parseFloat(values[4]);
                     currentTranslateY = parseFloat(values[5]);
                }
            }


            // 只有手機版啟動長按計時器
            if (isTouch && isMobile() && e.touches.length === 1) {
                e.preventDefault(); 
                longPressTimer = setTimeout(() => {
                    handleLongPress(e, clientX, clientY);
                    isEditorDragging = false; 
                }, LONG_PRESS_DURATION);
            }
        }

        // 統一處理滑鼠/觸摸移動
        function handleEditorMove(e) {
            if (!isEditorDragging) return;
            e.preventDefault(); 
            
            if (longPressTimer) {
                clearTimeout(longPressTimer);
                longPressTimer = null;
            }

            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;

            const deltaX = clientX - startX;
            const deltaY = clientY - startY;

            canvasContainer.style.transform = `translate(${currentTranslateX + deltaX}px, ${currentTranslateY + deltaY}px)`;
        }

        // 統一處理滑鼠/觸摸結束
        function handleEditorEnd(e) {
            if (!mainContent.classList.contains('view-editor')) return;
            
            if (longPressTimer) {
                clearTimeout(longPressTimer);
                longPressTimer = null;
            }

            if (isEditorDragging) {
                const style = window.getComputedStyle(canvasContainer);
                const transform = style.transform === 'none' ? 'matrix(1, 0, 0, 1, 0, 0)' : style.transform;
                const matrix = transform.match(/matrix.*\((.+)\)/);
                if (matrix) {
                    const values = matrix[1].split(', ');
                    currentTranslateX = parseFloat(values[4]);
                    currentTranslateY = parseFloat(values[5]);
                }
                isEditorDragging = false;
            }
        }
        
        // 為編輯器添加拖曳/觸摸事件監聽器
        document.addEventListener('mousedown', handleEditorStart);
        document.addEventListener('mousemove', handleEditorMove);
        document.addEventListener('mouseup', handleEditorEnd);
        document.addEventListener('touchstart', handleEditorStart, { passive: false });
        document.addEventListener('touchmove', handleEditorMove, { passive: false });
        document.addEventListener('touchend', handleEditorEnd);
        
        // 阻止在編輯器中拖曳圖片或文字的瀏覽器預設行為
        editorView.ondragstart = () => false;
    </script>
</body>
</html>
