// 獲取 3D 方形元素
const iphoneBody = document.getElementById('iphone-body');

// 儲存當前 3D 狀態
let currentXAngle = 15; // 初始 X 軸角度 (來自 CSS)
let currentYAngle = -45; // 初始 Y 軸角度 (來自 CSS)
let currentScale = 1;     // 初始縮放比例

// 儲存觸控點資訊
let startTouches = [];    // 儲存觸控開始時的點
let isDragging = false;

/**
 * 計算兩點之間的距離
 * @param {object} p1 - 第一個點 {clientX, clientY}
 * @param {object} p2 - 第二個點 {clientX, clientY}
 */
function getDistance(p1, p2) {
    const dx = p1.clientX - p2.clientX;
    const dy = p1.clientY - p2.clientY;
    return Math.sqrt(dx * dx + dy * dy);
}

// --- 觸控開始 ---
iphoneBody.addEventListener('touchstart', (e) => {
    // 阻止瀏覽器預設的行為（如滾動和放大縮小）
    e.preventDefault(); 
    
    startTouches = e.touches;
    isDragging = true;
});

// --- 觸控移動 ---
iphoneBody.addEventListener('touchmove', (e) => {
    if (!isDragging || e.touches.length === 0) return;

    // 1. 旋轉 (適用於單指或多指)
    if (e.touches.length >= 1) {
        // 使用第一個觸控點的移動來計算旋轉
        const touch = e.touches[0];
        const startTouch = startTouches[0];
        
        // 移動量 (delta)
        const dx = touch.clientX - startTouch.clientX;
        const dy = touch.clientY - startTouch.clientY;

        // 更新角度 (除以一個係數來控制旋轉速度)
        currentYAngle += dx * 0.5; // 左右移動控制 Y 軸旋轉
        currentXAngle -= dy * 0.5; // 上下移動控制 X 軸旋轉
        
        // 更新起始點，讓旋轉平滑
        startTouches = e.touches;
    }
    
    // 2. 縮放 (需要兩指)
    if (e.touches.length === 2 && startTouches.length === 2) {
        // 當前兩指距離
        const currentDistance = getDistance(e.touches[0], e.touches[1]);
        // 起始兩指距離
        const startDistance = getDistance(startTouches[0], startTouches[1]);
        
        // 計算比例變化 (Ratio)
        const scaleRatio = currentDistance / startDistance;
        
        // 將比例變化應用到當前縮放值
        currentScale *= scaleRatio;
        
        // 更新起始點，讓縮放平滑
        startTouches = e.touches;
    }

    // 3. 應用變換
    iphoneBody.style.transform = 
        `rotateX(${currentXAngle}deg) rotateY(${currentYAngle}deg) scale(${currentScale})`;
});

// --- 觸控結束 ---
iphoneBody.addEventListener('touchend', (e) => {
    if (e.touches.length === 0) {
        isDragging = false;
        // 清除起始觸控點，防止錯誤計算
        startTouches = []; 
    } else {
        // 如果還有手指在螢幕上，更新起始觸控點
        startTouches = e.touches;
    }
});
